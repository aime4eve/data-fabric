# 目录与权限 - 完成定义（DoD）清单

为 Story 1.1：目录与权限，发布前必须满足以下完成定义。该清单用于研发与验收的共同基线。

## 功能与业务约束
- 目录 CRUD：名称唯一（同级）、层级与路径正确、排序与移动更新子树路径。
- 权限继承与覆盖：父→子继承，子可局部覆盖；计算结果符合角色/主体组合矩阵。
- 模板应用：支持将模板权限批量应用到选定目录子树，幂等且可部分回滚。
- 审计记录：针对目录与权限的变更事件（创建、更新、移动、删除、模板应用、权限覆盖）有结构化审计条目。

## API 与契约
- REST/Swagger：`/directories`、`/permissions`、`/audits` 接口的请求/响应模型已定义并与前端交互对齐。
- 错误语义化：业务错误（唯一性、非法名称、目录不存在、权限冲突）返回语义化错误码与信息。
- 幂等键：批量操作（模板应用、排序移动）支持幂等键或幂等策略。

## 测试覆盖
- BDD→测试映射：Gherkin 场景均有对应的 E2E/集成/单元占位测试，后续实现时逐步启用并过绿。
- 并发与幂等：并发更新与重复提交的测试用例存在并通过（启用后）。
- 覆盖率目标：核心领域服务与权限计算的语句覆盖≥80%（启用后）。

## 并发控制与一致性
- 乐观锁/版本：目录与权限配置的更新包含版本字段或等价冲突检测。
- 事务与回滚：模板应用与批量更新在失败时具备一致性回滚策略与审计记录。

## 可观测性与运维
- 指标：`permission_apply_count`、`permission_conflict_count`、`directory_move_count`、`audit_event_count`。
- 结构化日志：关键路径包含 trace_id、actor、resource_id、action、result。
- 健康检查：`/healthz` 返回依赖探针（DB、搜索、存储）状态。

## 文档与交付物
- 前端交互规范（目录树与权限面板）已编写并与 data-testid 标注对齐。
- CI 计划与测试启用方案已编写，分支保护、必跑测试明确。
- BDD 到测试用例映射文档完成，作为需求追踪来源。

注：当前仓库已生成全部占位文件与骨架，未启用真实执行；待实现后逐步打开测试与校验项。