# CI 计划与测试启用方案（目录与权限）

## 流程与分支策略
- 分支保护：对 `main` 开启必跑检查（lint、unit、integration、e2e 可分阶段）。
- 合并策略：使用 squash merge；需要至少 1 个 Code Review 通过。
- 触发条件：PR、推送到 feature 分支、标签发布。

## 作业阶段
- Lint & 类型检查：前后端代码风格与类型校验。
- 单元测试：权限继承与覆盖计算的核心逻辑优先启用。
- 集成测试：目录与权限的 API 契约与错误语义，逐步启用。
- E2E 测试：目录树与权限面板的关键路径，在后端接口稳定后启用。

## 渐进启用策略
- 阶段一：仅跑单元测试（后端权限逻辑）。
- 阶段二：启用 API 集成测试（`/directories`、`/permissions`）。
- 阶段三：启用 E2E（Playwright），并开启前端 data-testid 标注核对。
- 阶段四：并发与幂等测试纳入必跑。

## 报告与质量门槛
- 覆盖率门槛：后端核心模块 ≥ 80%。
- 测试报告：JUnit/HTML 报告归档；关键场景失败阻止合并。
- 可观测性检查：健康检查与指标探针验证在部署作业中执行。

## 失败处理与回滚
- 测试失败：阻止合并，要求修复并重新运行。
- 部署失败：保持上一个稳定版本，并记录审计事件。