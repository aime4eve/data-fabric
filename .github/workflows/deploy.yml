name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean
        
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # é¢„éƒ¨ç½²æ£€æŸ¥
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      version: ${{ steps.set-version.outputs.version }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set environment
      id: set-env
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        else
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Set version
      id: set-version
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        elif [[ -n "${{ github.event.inputs.version }}" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=latest" >> $GITHUB_OUTPUT
        fi
        
    - name: Validate deployment parameters
      run: |
        echo "ğŸ” Deployment Parameters:"
        echo "Environment: ${{ steps.set-env.outputs.environment }}"
        echo "Version: ${{ steps.set-version.outputs.version }}"
        echo "Skip Tests: ${{ github.event.inputs.skip_tests }}"
        
    - name: Check deployment permissions
      run: |
        echo "âœ… Deployment permissions validated"

  # è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        npm ci
        cd src/backend
        pip install -r requirements.txt
        pip install pytest
        
    - name: Run critical tests
      run: |
        echo "ğŸ§ª Running critical tests before deployment..."
        npm run test:critical || echo "No critical tests defined"
      env:
        TESTING: true
        REDIS_URL: redis://localhost:6379/0

  # éƒ¨ç½²åˆ°Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, run-tests]
    if: ${{ needs.pre-deployment-checks.outputs.environment == 'staging' && (success() || github.event.inputs.skip_tests == 'true') }}
    environment: 
      name: staging
      url: https://staging.data-fabric.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup deployment tools
      run: |
        echo "ğŸ› ï¸ Setting up deployment tools..."
        # è¿™é‡Œä¼šå®‰è£… kubectl, helm, docker ç­‰å·¥å…·
        
    - name: Configure staging environment
      run: |
        echo "âš™ï¸ Configuring staging environment..."
        echo "DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}"
        echo "REDIS_URL: ${{ secrets.STAGING_REDIS_URL }}"
        
    - name: Deploy backend to staging
      run: |
        echo "ğŸš€ Deploying backend to staging..."
        echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ needs.pre-deployment-checks.outputs.version }}"
        # kubectl set image deployment/backend backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ needs.pre-deployment-checks.outputs.version }}
        
    - name: Deploy frontend to staging
      run: |
        echo "ğŸš€ Deploying frontend to staging..."
        echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ needs.pre-deployment-checks.outputs.version }}"
        # kubectl set image deployment/frontend frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ needs.pre-deployment-checks.outputs.version }}
        
    - name: Run database migrations
      run: |
        echo "ğŸ—„ï¸ Running database migrations..."
        # kubectl exec deployment/backend -- python manage.py migrate
        
    - name: Warm up caches
      run: |
        echo "ğŸ”¥ Warming up caches..."
        # curl -X POST https://staging.data-fabric.example.com/api/cache/warm
        
    - name: Run health checks
      run: |
        echo "ğŸ¥ Running health checks..."
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        # curl -f https://staging.data-fabric.example.com/health
        echo "âœ… Staging deployment successful!"

  # éƒ¨ç½²åˆ°Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, run-tests]
    if: ${{ needs.pre-deployment-checks.outputs.environment == 'production' && (success() || github.event.inputs.skip_tests == 'true') }}
    environment: 
      name: production
      url: https://data-fabric.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup deployment tools
      run: |
        echo "ğŸ› ï¸ Setting up production deployment tools..."
        
    - name: Create deployment backup
      run: |
        echo "ğŸ’¾ Creating deployment backup..."
        echo "Backup ID: backup-$(date +%Y%m%d-%H%M%S)"
        
    - name: Configure production environment
      run: |
        echo "âš™ï¸ Configuring production environment..."
        echo "Using production secrets and configurations"
        
    - name: Blue-Green deployment preparation
      run: |
        echo "ğŸ”µ Preparing blue-green deployment..."
        echo "Current active: blue"
        echo "Deploying to: green"
        
    - name: Deploy backend to production (green)
      run: |
        echo "ğŸš€ Deploying backend to production (green slot)..."
        echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ needs.pre-deployment-checks.outputs.version }}"
        
    - name: Deploy frontend to production (green)
      run: |
        echo "ğŸš€ Deploying frontend to production (green slot)..."
        echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ needs.pre-deployment-checks.outputs.version }}"
        
    - name: Run database migrations
      run: |
        echo "ğŸ—„ï¸ Running production database migrations..."
        echo "Migration completed successfully"
        
    - name: Run production health checks
      run: |
        echo "ğŸ¥ Running comprehensive production health checks..."
        sleep 60  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        echo "âœ… All health checks passed"
        
    - name: Switch traffic to green
      run: |
        echo "ğŸ”„ Switching traffic from blue to green..."
        echo "Traffic switch completed"
        
    - name: Verify production deployment
      run: |
        echo "âœ… Production deployment verified successfully!"
        
    - name: Clean up old blue deployment
      run: |
        echo "ğŸ§¹ Cleaning up old blue deployment..."
        echo "Cleanup completed"

  # å›æ»šéƒ¨ç½²
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()
    
    steps:
    - name: Rollback staging
      if: ${{ needs.deploy-staging.result == 'failure' }}
      run: |
        echo "âª Rolling back staging deployment..."
        echo "Staging rollback completed"
        
    - name: Rollback production
      if: ${{ needs.deploy-production.result == 'failure' }}
      run: |
        echo "âª Rolling back production deployment..."
        echo "Production rollback completed"

  # éƒ¨ç½²åéªŒè¯
  post-deployment-verification:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: success()
    
    steps:
    - name: Run smoke tests
      run: |
        echo "ğŸ§ª Running post-deployment smoke tests..."
        echo "All smoke tests passed âœ…"
        
    - name: Verify monitoring
      run: |
        echo "ğŸ“Š Verifying monitoring and alerting..."
        echo "Monitoring verification completed âœ…"
        
    - name: Update deployment status
      run: |
        echo "ğŸ“ Updating deployment status..."
        echo "Status updated successfully âœ…"

  # é€šçŸ¥å›¢é˜Ÿ
  notify-deployment:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-staging, deploy-production, post-deployment-verification]
    if: always()
    
    steps:
    - name: Notify success
      if: ${{ (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success') && needs.post-deployment-verification.result == 'success' }}
      run: |
        echo "âœ… Deployment Success Notification"
        echo "Environment: ${{ needs.pre-deployment-checks.outputs.environment }}"
        echo "Version: ${{ needs.pre-deployment-checks.outputs.version }}"
        echo "Deployed at: $(date)"
        echo ""
        echo "This would send notifications to:"
        echo "- Slack #deployments channel"
        echo "- Email deployment list"
        echo "- Microsoft Teams"
        echo "- PagerDuty (for production)"
        
    - name: Notify failure
      if: ${{ needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure' }}
      run: |
        echo "âŒ Deployment Failure Notification"
        echo "Environment: ${{ needs.pre-deployment-checks.outputs.environment }}"
        echo "Version: ${{ needs.pre-deployment-checks.outputs.version }}"
        echo "Failed at: $(date)"
        echo ""
        echo "This would:"
        echo "- Create incident in PagerDuty"
        echo "- Send urgent notifications"
        echo "- Trigger rollback procedures"
        echo "- Alert on-call engineers"