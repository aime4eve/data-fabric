# 知识库系统部署指南

## 文档信息
- **文档版本**: v1.0
- **创建日期**: 2024-01-15
- **最后更新**: 2024-01-15
- **负责人**: 运维工程师
- **审核人**: 技术负责人

## 系统要求

### 硬件要求

#### 最小配置
- **CPU**: 4核心 2.0GHz
- **内存**: 8GB RAM
- **存储**: 100GB SSD
- **网络**: 100Mbps

#### 推荐配置
- **CPU**: 8核心 2.4GHz
- **内存**: 16GB RAM
- **存储**: 500GB SSD
- **网络**: 1Gbps

#### 生产环境配置
- **CPU**: 16核心 3.0GHz
- **内存**: 32GB RAM
- **存储**: 1TB SSD (系统) + 2TB SSD (数据)
- **网络**: 10Gbps

### 软件要求

#### 操作系统
- **Linux**: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
- **Docker**: 20.10+
- **Docker Compose**: 2.0+

#### 数据库
- **NebulaGraph**: 3.8.0+
- **Redis**: 7.0+

#### 运行时环境
- **Python**: 3.11+
- **Node.js**: 18.0+
- **Nginx**: 1.20+

## 部署架构

### 单机部署架构
```
┌─────────────────────────────────────┐
│              Nginx                  │
│         (反向代理/负载均衡)           │
└─────────────┬───────────────────────┘
              │
┌─────────────▼───────────────────────┐
│          Frontend                   │
│        (React App)                  │
└─────────────────────────────────────┘
              │
┌─────────────▼───────────────────────┐
│          Backend                    │
│        (Flask API)                  │
└─────────────┬───────────────────────┘
              │
    ┌─────────▼─────────┐    ┌─────────────┐
    │   NebulaGraph     │    │    Redis    │
    │   (图数据库)       │    │   (缓存)     │
    └───────────────────┘    └─────────────┘
```

### 集群部署架构
```
                    ┌─────────────┐
                    │ Load Balancer│
                    │   (Nginx)    │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐        ┌────▼────┐
   │Frontend │        │Frontend │        │Frontend │
   │ Node 1  │        │ Node 2  │        │ Node 3  │
   └─────────┘        └─────────┘        └─────────┘
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐        ┌────▼────┐
   │Backend  │        │Backend  │        │Backend  │
   │ Node 1  │        │ Node 2  │        │ Node 3  │
   └─────────┘        └─────────┘        └─────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
    ┌──────────────────────┼──────────────────────┐
    │                      │                      │
┌───▼────┐           ┌─────▼─────┐         ┌──────▼──────┐
│NebulaGraph        │   Redis    │         │   MinIO     │
│ Cluster           │  Cluster   │         │  (文件存储)  │
│(图数据库集群)      │  (缓存集群) │         │             │
└────────────┘      └───────────┘         └─────────────┘
```

## 部署方式

### 方式一: Docker Compose 部署 (推荐)

#### 1. 环境准备
```bash
# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 2. 获取部署包
```bash
# 下载部署包
wget https://releases.example.com/knowledge-base-app-v1.0.0.tar.gz

# 解压部署包
tar -xzf knowledge-base-app-v1.0.0.tar.gz
cd knowledge-base-app

# 查看目录结构
ls -la
```

#### 3. 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
vim .env
```

**环境变量配置示例**:
```bash
# 应用配置
APP_ENV=production
APP_DEBUG=false
APP_SECRET_KEY=your-secret-key-here

# 数据库配置
NEBULA_HOST=nebula-graphd
NEBULA_PORT=9669
NEBULA_USERNAME=root
NEBULA_PASSWORD=nebula
NEBULA_SPACE=knowledge_base

# Redis配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password
REDIS_DB=0

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ACCESS_TOKEN_EXPIRES=3600

# 文件存储配置
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=knowledge-base

# 监控配置
PROMETHEUS_ENABLED=true
GRAFANA_ADMIN_PASSWORD=admin123
```

#### 4. 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f
```

#### 5. 初始化数据库
```bash
# 执行数据库迁移
docker-compose exec backend python manage.py migrate

# 创建超级用户
docker-compose exec backend python manage.py create-superuser

# 导入初始数据
docker-compose exec backend python manage.py seed-data
```

### 方式二: Kubernetes 部署

#### 1. 准备 Kubernetes 集群
```bash
# 确认集群状态
kubectl cluster-info
kubectl get nodes

# 创建命名空间
kubectl create namespace knowledge-base
```

#### 2. 部署配置文件
```bash
# 应用配置映射
kubectl apply -f k8s/configmap.yaml

# 应用密钥
kubectl apply -f k8s/secrets.yaml

# 部署数据库
kubectl apply -f k8s/nebula/
kubectl apply -f k8s/redis/

# 部署应用
kubectl apply -f k8s/backend/
kubectl apply -f k8s/frontend/

# 部署 Ingress
kubectl apply -f k8s/ingress.yaml
```

#### 3. 验证部署
```bash
# 查看 Pod 状态
kubectl get pods -n knowledge-base

# 查看服务状态
kubectl get services -n knowledge-base

# 查看 Ingress
kubectl get ingress -n knowledge-base
```

### 方式三: 手动部署

#### 1. 部署 NebulaGraph
```bash
# 下载 NebulaGraph
wget https://github.com/vesoft-inc/nebula/releases/download/v3.8.0/nebula-graph-3.8.0.el8.x86_64.rpm

# 安装 NebulaGraph
sudo rpm -ivh nebula-graph-3.8.0.el8.x86_64.rpm

# 启动服务
sudo systemctl start nebula-graphd
sudo systemctl start nebula-metad
sudo systemctl start nebula-storaged

# 设置开机自启
sudo systemctl enable nebula-graphd
sudo systemctl enable nebula-metad
sudo systemctl enable nebula-storaged
```

#### 2. 部署 Redis
```bash
# 安装 Redis
sudo yum install redis -y

# 配置 Redis
sudo vim /etc/redis.conf

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis
```

#### 3. 部署后端服务
```bash
# 创建应用用户
sudo useradd -m -s /bin/bash knowledge-base

# 切换到应用用户
sudo su - knowledge-base

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
vim .env

# 运行数据库迁移
python manage.py migrate

# 启动应用
gunicorn --bind 0.0.0.0:5000 --workers 4 app:app
```

#### 4. 部署前端服务
```bash
# 安装 Node.js
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install nodejs -y

# 构建前端
npm install
npm run build

# 配置 Nginx
sudo vim /etc/nginx/conf.d/knowledge-base.conf
```

**Nginx 配置示例**:
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /var/www/knowledge-base/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

## 配置说明

### 数据库配置

#### NebulaGraph 配置
```bash
# 编辑配置文件
sudo vim /usr/local/nebula/etc/nebula-graphd.conf

# 关键配置项
--port=9669
--ws_ip=0.0.0.0
--ws_http_port=19669
--meta_server_addrs=127.0.0.1:9559
--enable_authorize=true
--auth_type=password
```

#### Redis 配置
```bash
# 编辑配置文件
sudo vim /etc/redis.conf

# 关键配置项
bind 0.0.0.0
port 6379
requirepass your-password
maxmemory 2gb
maxmemory-policy allkeys-lru
```

### 应用配置

#### 后端配置 (config.py)
```python
import os

class Config:
    # 基础配置
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'
    
    # 数据库配置
    NEBULA_CONFIG = {
        'host': os.environ.get('NEBULA_HOST', 'localhost'),
        'port': int(os.environ.get('NEBULA_PORT', 9669)),
        'username': os.environ.get('NEBULA_USERNAME', 'root'),
        'password': os.environ.get('NEBULA_PASSWORD', 'nebula'),
        'space': os.environ.get('NEBULA_SPACE', 'knowledge_base')
    }
    
    # Redis 配置
    REDIS_CONFIG = {
        'host': os.environ.get('REDIS_HOST', 'localhost'),
        'port': int(os.environ.get('REDIS_PORT', 6379)),
        'password': os.environ.get('REDIS_PASSWORD'),
        'db': int(os.environ.get('REDIS_DB', 0))
    }
    
    # JWT 配置
    JWT_SECRET_KEY = os.environ.get('JWT_SECRET_KEY', 'jwt-secret')
    JWT_ACCESS_TOKEN_EXPIRES = int(os.environ.get('JWT_ACCESS_TOKEN_EXPIRES', 3600))
```

#### 前端配置 (.env.production)
```bash
# API 配置
VITE_API_BASE_URL=https://api.your-domain.com
VITE_WS_BASE_URL=wss://api.your-domain.com

# 功能开关
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_MONITORING=true

# 第三方服务
VITE_SENTRY_DSN=your-sentry-dsn
```

## 监控配置

### Prometheus 配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'knowledge-base-backend'
    static_configs:
      - targets: ['backend:5000']
    metrics_path: '/metrics'
    
  - job_name: 'nebula-graph'
    static_configs:
      - targets: ['nebula-graphd:19669']
      
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
```

### Grafana 仪表板
- **系统监控**: CPU、内存、磁盘、网络
- **应用监控**: 请求量、响应时间、错误率
- **数据库监控**: 连接数、查询性能、存储使用
- **业务监控**: 用户活跃度、知识创建量、搜索量

## 安全配置

### SSL/TLS 配置
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # 其他安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}
```

### 防火墙配置
```bash
# 开放必要端口
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=9669/tcp  # NebulaGraph
sudo firewall-cmd --reload

# 限制访问
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='10.0.0.0/8' port protocol='tcp' port='9669' accept"
```

## 备份策略

### 数据备份
```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/knowledge-base"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份 NebulaGraph
nebula-dump --host=localhost --port=9669 --user=root --password=nebula --space=knowledge_base --output=$BACKUP_DIR/nebula_$DATE.sql

# 备份 Redis
redis-cli --rdb $BACKUP_DIR/redis_$DATE.rdb

# 备份应用文件
tar -czf $BACKUP_DIR/app_$DATE.tar.gz /opt/knowledge-base/uploads

# 清理旧备份 (保留30天)
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.rdb" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

### 自动备份
```bash
# 添加到 crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /opt/scripts/backup.sh
```

## 故障排除

### 常见问题

#### 1. 服务无法启动
```bash
# 检查端口占用
netstat -tlnp | grep :5000

# 检查日志
docker-compose logs backend
journalctl -u knowledge-base

# 检查配置文件
python -c "import config; print(config.Config.NEBULA_CONFIG)"
```

#### 2. 数据库连接失败
```bash
# 测试 NebulaGraph 连接
nebula-console -addr 127.0.0.1 -port 9669 -u root -p nebula

# 测试 Redis 连接
redis-cli -h 127.0.0.1 -p 6379 -a your-password ping
```

#### 3. 性能问题
```bash
# 检查系统资源
top
htop
iotop

# 检查数据库性能
SHOW STATS;  # NebulaGraph
INFO stats   # Redis
```

### 日志分析
```bash
# 应用日志
tail -f /var/log/knowledge-base/app.log

# Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 系统日志
journalctl -f -u knowledge-base
```

## 性能优化

### 系统优化
```bash
# 内核参数优化
echo 'net.core.somaxconn = 65535' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_max_syn_backlog = 65535' >> /etc/sysctl.conf
sysctl -p

# 文件描述符限制
echo '* soft nofile 65535' >> /etc/security/limits.conf
echo '* hard nofile 65535' >> /etc/security/limits.conf
```

### 应用优化
```python
# Gunicorn 配置
bind = "0.0.0.0:5000"
workers = 4
worker_class = "gevent"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
preload_app = True
```

### 数据库优化
```bash
# NebulaGraph 优化
--enable_partitions_in_index=true
--rocksdb_block_cache=2048MB
--rocksdb_row_cache=512MB

# Redis 优化
maxmemory 4gb
maxmemory-policy allkeys-lru
tcp-keepalive 300
```

## 版本升级

### 升级步骤
1. **备份数据**: 执行完整备份
2. **停止服务**: 停止所有相关服务
3. **更新代码**: 部署新版本代码
4. **数据迁移**: 执行数据库迁移脚本
5. **配置更新**: 更新配置文件
6. **启动服务**: 启动所有服务
7. **验证功能**: 执行功能测试
8. **监控观察**: 观察系统运行状态

### 回滚方案
```bash
#!/bin/bash
# rollback.sh

# 停止服务
docker-compose down

# 恢复代码
git checkout previous-version

# 恢复数据库
nebula-restore --input=/backup/nebula_backup.sql

# 恢复配置
cp /backup/config/.env .env

# 启动服务
docker-compose up -d
```

## 联系支持

### 技术支持
- **邮箱**: support@example.com
- **电话**: +86-400-xxx-xxxx
- **在线支持**: https://support.example.com

### 紧急联系
- **运维负责人**: [姓名] - [电话]
- **技术负责人**: [姓名] - [电话]
- **项目经理**: [姓名] - [电话]

---

**文档维护**: 运维团队  
**最后更新**: 2024-01-15  
**版本**: v1.0